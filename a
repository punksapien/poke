#!/bin/bash

# Exit immediately if any command fails.
set -e

# --- Introduction ---
echo "======================================================="
echo "  Ubuntu System Recovery Script"
echo "======================================================="
echo "Internet connection detected. Proceeding with system repair."
echo "This script will:"
echo "1. Rebuild the system's software sources."
echo "2. Fully update and repair all broken packages."
echo "-------------------------------------------------------"
sleep 3

# --- Step 1: Check for Root Privileges ---
if [[ $EUID -ne 0 ]]; then
   echo "!! This script must be run with sudo." 
   echo "!! Please run it like this: sudo ./recovery.sh"
   exit 1
fi

# --- Step 2: Rebuild sources.list ---
echo ""
echo "--- [Step 1/3] Rebuilding /etc/apt/sources.list... ---"

tee /etc/apt/sources.list > /dev/null <<EOF
deb http://archive.ubuntu.com/ubuntu/ noble main restricted universe multiverse
deb http://archive.ubuntu.com/ubuntu/ noble-updates main restricted universe multiverse
deb http://archive.ubuntu.com/ubuntu/ noble-backports main restricted universe multiverse
deb http://security.ubuntu.com/ubuntu/ noble-security main restricted universe multiverse
EOF

echo "✓ Software sources file has been recreated."

# --- Step 3: Repair and Upgrade the System ---
echo ""
echo "--- [Step 2/3] Updating package information... ---"
apt-get update

echo ""
echo "--- [Step 3/3] Repairing and upgrading system (This will take a long time)... ---"
# dist-upgrade is used to intelligently handle the conflicts from the failed release upgrade.
# The '-y' flag automatically says 'yes' to prompts.
apt-get dist-upgrade -y

# Clean up any old, unnecessary packages.
apt-get autoremove -y

# --- Final Success Message ---
echo ""
echo "======================================================="
echo "  ✓ SUCCESS! The system repair process is complete."
echo "======================================================="
echo ""
echo "The final step is to reboot your computer."
echo "Please run the following command now:"
echo ""
echo "  reboot"
echo ""
